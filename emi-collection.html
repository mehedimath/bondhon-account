<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EMI Collection - Bondhon Enterprise</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 250px;
        padding: 70px 0 0;
        background-color: #f8f9fa;
        color: #212529;
        height: 100vh;
        overflow-y: auto;
      }

      .sidebar .nav-link {
        color: #212529;
        padding: 10px 20px;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: #212529;
        background-color: #e4e5e6;
      }

      .sidebar .nav-link .fa {
        width: 20px;
        text-align: center;
        margin-right: 10px;
      }

      .nav-sub-link {
        margin-left: 50px;
      }

      .main-content {
        margin-left: 250px;
        padding: 20px;
        padding-top: 70px;
      }

      .navbar {
        z-index: 1030;
      }

      .navbar-brand {
        font-weight: 700;
      }

      .payment-due {
        background-color: #fff0f1;
      }

      .payment-paid {
        background-color: #e9f7ef;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.html">Bondhon Enterprise</a>
        <div class="ms-auto d-flex align-items-center">
          <div class="user-info me-3">
            <i class="fa fa-user-circle"></i> Admin
          </div>
          <a href="index.html" class="btn btn-outline-light btn-sm"
            ><i class="fa fa-sign-out-alt me-1"></i>Logout</a
          >
        </div>
      </div>
    </nav>

    <!-- Sidebar -->

    <div class="sidebar">
      <nav class="nav flex-column">
        <a class="nav-link active" href="dashboard.html"
          ><i class="fa fa-tachometer-alt fa-fw"></i> Dashboard</a
        >
        <a class="nav-link" href="all-create.html"
          ><i class="fa fa-tachometer-alt fa-fw"></i> Quick Add</a
        >
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#contactsCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-users fa-fw"></i> Contacts
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="contactsCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="customers-list.html"
              >Customers</a
            >
            <a class="nav-link nav-sub-link" href="suppliers-manage.html"
              >Suppliers</a
            >
          </nav>
        </div>
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#inventoryCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-box-open fa-fw"></i> Inventory
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="inventoryCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="inventory-products.html"
              >Product List</a
            >
            <a class="nav-link nav-sub-link" href="items-manage.html"
              >Item Categories</a
            >
            <a class="nav-link nav-sub-link" href="brands-manage.html"
              >Brands</a
            >
          </nav>
        </div>
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#purchasesCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-shopping-cart fa-fw"></i> Purchases
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="purchasesCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="purchases-create.html"
              >New Purchase</a
            >
            <a class="nav-link nav-sub-link" href="purchase_list.html"
              >Purchase List</a
            >
          </nav>
        </div>
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#salesCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-file-invoice-dollar fa-fw"></i> Sales
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="salesCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="sales-create.html"
              >New Invoice</a
            >
            <a class="nav-link nav-sub-link" href="sales-manage-invoices.html"
              >Invoice List</a
            >
            <a class="nav-link nav-sub-link" href="sales-return-create.html"
              >Process Return</a
            >
          </nav>
        </div>
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#financeCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-wallet fa-fw"></i> Finance
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="financeCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="expenses-manage.html"
              >Manage Expenses</a
            >
          </nav>
        </div>
        <!-- New Collection Links -->
        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#collectionsCollapse"
          role="button"
          aria-expanded="true"
          ><i class="fa fa-hand-holding-dollar fa-fw"></i> Collections
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i
        ></a>
        <div class="collapse show" id="collectionsCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="emi-collection.html"
              >EMI Collection</a
            ><a class="nav-link nav-sub-link" href="due-collection.html"
              >Due Collection</a
            ><a class="nav-link nav-sub-link" href="customer-ledger.html"
              >Customer Ledger</a
            >
          </nav>
        </div>

        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#accountingCollapse"
          role="button"
          aria-expanded="true"
          ><i class="fa fa-hand-holding-dollar fa-fw"></i> Accounting
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i
        ></a>
        <div class="collapse show" id="accountingCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="account-dashboard.html"
              >Accounts Dashboard</a
            ><a class="nav-link nav-sub-link" href="chartofaccount.html"
              >Chart of Account</a
            ><a class="nav-link nav-sub-link" href="voucher_form.html"
              >Voucher Entry</a
            ><a class="nav-link nav-sub-link" href="voucher-list.html"
              >Voucher List</a
            ><a class="nav-link nav-sub-link" href="trial-balance.html"
              >Trial Balance</a
            ><a class="nav-link nav-sub-link" href="balance-sheet.html"
              >Balance Sheet</a
            >
          </nav>
        </div>

        <a
          class="nav-link"
          data-bs-toggle="collapse"
          href="#reportsCollapse"
          role="button"
          aria-expanded="true"
        >
          <i class="fa fa-chart-pie fa-fw"></i> Reports
          <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
        </a>
        <div class="collapse show" id="reportsCollapse">
          <nav class="nav flex-column">
            <a class="nav-link nav-sub-link" href="reports-sales.html"
              >Sales Report</a
            >
            <a class="nav-link nav-sub-link" href="reports-stock-ledger.html"
              >Stock Ledger</a
            >
            <a class="nav-link nav-sub-link" href="reports-customer-dues.html"
              >Customer Dues</a
            >
          </nav>
        </div>
        <a class="nav-link" href="settings.html"
          ><i class="fa fa-cog fa-fw"></i> Settings</a
        >
      </nav>
    </div>


    <main class="main-content">
      <div class="container-fluid">
        <h1 class="h3 mb-4">Collect EMI Payment</h1>
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">Find EMI Plan</h5>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="searchInput"
                placeholder="Search by Customer Name, Contact, or Invoice #"
                list="customer-list"
              />
              <datalist id="customer-list">
                <option
                  data-customer-name="Md. Mahfooz"
                  data-contact="01613-505311"
                  data-invoice="6084"
                  value="INV-6084 | Md. Mahfooz"
                ></option>
                <option
                  data-customer-name="Salma Akter"
                  data-contact="01773-047204"
                  data-invoice="6079"
                  value="INV-6079 | Salma Akter"
                ></option>
              </datalist>

              <button class="btn btn-primary" type="button" id="searchBtn">
                <i class="fa fa-search me-1"></i> Search
              </button>
            </div>
          </div>
        </div>

        <div class="d-none" id="emiDetailsContainer">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">
                EMI Schedule for Invoice <span id="detailsInvoiceId"></span>
              </h5>
              <div class="text-end">
                <h6 class="mb-0" id="detailsCustomerName"></h6>
                <small id="detailsCustomerContact" class="text-muted"></small>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Due Date</th>
                      <th class="text-end">Amount</th>
                      <th>Status</th>
                      <th class="text-center">Action</th>
                    </tr>
                  </thead>
                  <tbody id="emiScheduleTbody">
                    <!-- JS will populate this -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="text-center mt-4" id="placeholderText">
          <i class="fa fa-search fa-3x text-muted mb-2"></i>
          <p class="text-muted">
            Search for an invoice to view the EMI schedule.
          </p>
        </div>
      </div>
    </main>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Record Payment for Installment #<span
                id="modalInstallmentNum"
              ></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="paymentForm">
              <div class="mb-3">
                <label class="form-label">Invoice #:</label>
                <p
                  class="form-control-plaintext fw-bold"
                  id="modalInvoiceId"
                ></p>
              </div>
              <div class="mb-3">
                <label class="form-label">Customer:</label>
                <p class="form-control-plaintext" id="modalCustomerName"></p>
              </div>
              <div class="mb-3">
                <label for="modalPaymentAmount" class="form-label"
                  >Payment Amount</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="modalPaymentAmount"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label for="modalPaymentDate" class="form-label"
                  >Payment Date</label
                >
                <input type="date" class="form-control" id="modalPaymentDate" />
              </div>
              <div class="mb-3">
                <label for="modalPaymentNotes" class="form-label"
                  >Notes (Optional)</label
                >
                <textarea
                  class="form-control"
                  id="modalPaymentNotes"
                  rows="2"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-success" id="savePaymentBtn">
              <i class="fa fa-check-circle me-1"></i>Confirm Payment
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchBtn = document.getElementById("searchBtn");
        const emiDetailsContainer = document.getElementById(
          "emiDetailsContainer"
        );
        const placeholderText = document.getElementById("placeholderText");
        const paymentModal = new bootstrap.Modal(
          document.getElementById("paymentModal")
        );

        // Sample Data
        const emiPlans = {
          6084: {
            customerName: "Md. Mahfooz",
            contact: "01613-505311",
            installments: [
              { num: 1, dueDate: "2025-04-03", amount: 2549.5, status: "Paid" },
              { num: 2, dueDate: "2025-05-03", amount: 2549.5, status: "Paid" },
              { num: 3, dueDate: "2025-06-03", amount: 2549.5, status: "Due" },
              {
                num: 4,
                dueDate: "2025-07-03",
                amount: 2549.5,
                status: "Upcoming",
              },
              {
                num: 5,
                dueDate: "2025-08-03",
                amount: 2549.5,
                status: "Upcoming",
              },
            ],
          },
          6079: {
            customerName: "Salma Akter",
            contact: "01773-047204",
            installments: [
              { num: 1, dueDate: "2025-07-15", amount: 5120.0, status: "Due" },
              {
                num: 2,
                dueDate: "2025-08-15",
                amount: 5120.0,
                status: "Upcoming",
              },
            ],
          },
        };

        function formatCurrency(num) {
          return `à§³ ${num.toLocaleString("en-IN", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })}`;
        }

        function displayEmiSchedule(invoiceId) {
          const plan = emiPlans[invoiceId];
          if (!plan) {
            alert("No EMI plan found for this invoice.");
            return;
          }

          document.getElementById("detailsInvoiceId").textContent = invoiceId;
          document.getElementById("detailsCustomerName").textContent =
            plan.customerName;
          document.getElementById("detailsCustomerContact").textContent =
            plan.contact;

          const tbody = document.getElementById("emiScheduleTbody");
          tbody.innerHTML = "";
          plan.installments.forEach((inst) => {
            let statusBadge;
            let actionButton;
            let rowClass = "";

            switch (inst.status) {
              case "Paid":
                statusBadge = '<span class="badge bg-success">Paid</span>';
                actionButton = `<button class="btn btn-sm btn-secondary" disabled><i class="fa fa-check"></i> Paid</button>`;
                rowClass = "payment-paid";
                break;
              case "Due":
                statusBadge = '<span class="badge bg-danger">Due</span>';
                actionButton = `<button class="btn btn-sm btn-success collect-btn" data-invoice="${invoiceId}" data-installment="${inst.num}" data-amount="${inst.amount}"><i class="fa fa-hand-holding-dollar"></i> Collect</button>`;
                rowClass = "payment-due";
                break;
              default: // Upcoming
                statusBadge =
                  '<span class="badge bg-info text-dark">Upcoming</span>';
                actionButton = `<button class="btn btn-sm btn-outline-secondary" disabled>Collect</button>`;
                break;
            }

            const rowHtml = `
                        <tr class="${rowClass}">
                            <td>${inst.num}</td>
                            <td>${new Date(
                              inst.dueDate + "T00:00:00"
                            ).toLocaleDateString("en-GB")}</td>
                            <td class="text-end">${formatCurrency(
                              inst.amount
                            )}</td>
                            <td>${statusBadge}</td>
                            <td class="text-center">${actionButton}</td>
                        </tr>`;
            tbody.insertAdjacentHTML("beforeend", rowHtml);
          });

          placeholderText.classList.add("d-none");
          emiDetailsContainer.classList.remove("d-none");
        }

        searchBtn.addEventListener("click", () => {
          const searchInput = document.getElementById("searchInput").value;
          const selectedOption = Array.from(
            document.getElementById("customer-list").options
          ).find((opt) => opt.value === searchInput);

          if (selectedOption) {
            const invoiceId = selectedOption.dataset.invoice;
            displayEmiSchedule(invoiceId);
          } else {
            alert("Please select a valid customer/invoice from the list.");
          }
        });

        document
          .getElementById("emiScheduleTbody")
          .addEventListener("click", function (e) {
            if (
              e.target.classList.contains("collect-btn") ||
              e.target.closest(".collect-btn")
            ) {
              const btn = e.target.closest(".collect-btn");
              const invoiceId = btn.dataset.invoice;
              const installmentNum = btn.dataset.installment;
              const amount = btn.dataset.amount;
              const customer = emiPlans[invoiceId].customerName;

              document.getElementById("modalInvoiceId").textContent = invoiceId;
              document.getElementById("modalInstallmentNum").textContent =
                installmentNum;
              document.getElementById("modalCustomerName").textContent =
                customer;
              document.getElementById("modalPaymentAmount").value =
                parseFloat(amount).toFixed(2);
              document.getElementById("modalPaymentDate").valueAsDate =
                new Date();

              paymentModal.show();
            }
          });

        document
          .getElementById("savePaymentBtn")
          .addEventListener("click", function () {
            const invoiceId =
              document.getElementById("modalInvoiceId").textContent;
            const installmentNum = parseInt(
              document.getElementById("modalInstallmentNum").textContent
            );

            // In a real app, you'd send this to a server. Here we just simulate.
            const plan = emiPlans[invoiceId];
            const installment = plan.installments.find(
              (i) => i.num === installmentNum
            );
            installment.status = "Paid";

            alert(
              `Payment for Invoice #${invoiceId}, Installment #${installmentNum} has been recorded successfully!`
            );
            paymentModal.hide();
            displayEmiSchedule(invoiceId); // Refresh the table
          });
      });
    </script>
  </body>
</html>
