<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Invoice - Bondhon Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Same CSS */
        body {
            background-color: #f8f9fa
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 250px;
            padding: 70px 0 0;
            background-color: #f8f9fa;
            ;
            color: #212529;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            color: #212529;
            padding: 10px 20px
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #212529;
            background-color: #e4e5e6
        }

        .sidebar .nav-link .fa {
            width: 20px;
            text-align: center;
            margin-right: 10px
        }

        .nav-sub-link {
            margin-left: 50px;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            padding-top: 70px
        }

        .navbar {
            z-index: 1030
        }

        .navbar-brand {
            font-weight: 700
        }

        .invoice-total-box {
            background-color: #e9ecef;
            border-radius: .375rem;
            padding: 1.5rem
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">Bondhon Enterprise</a>
            <!-- User Info and Logout Button -->
            <div class="ms-auto d-flex align-items-center">
                <div class="user-info me-3">
                    <i class="fa fa-user-circle"></i> Admin
                </div>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="fa fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="sidebar">
        <nav class="nav flex-column">
            <a class="nav-link active" href="dashboard.html"><i class="fa fa-tachometer-alt fa-fw"></i> Dashboard</a>
            <a class="nav-link" href="all-create.html"><i class="fa fa-tachometer-alt fa-fw"></i> Quick Add</a>
            <a class="nav-link" data-bs-toggle="collapse" href="#contactsCollapse" role="button" aria-expanded="true">
                <i class="fa fa-users fa-fw"></i> Contacts <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="contactsCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="customers-list.html">Customers</a>
                    <a class="nav-link nav-sub-link" href="suppliers-manage.html">Suppliers</a>
                </nav>
            </div>
            <a class="nav-link" data-bs-toggle="collapse" href="#inventoryCollapse" role="button" aria-expanded="true">
                <i class="fa fa-box-open fa-fw"></i> Inventory <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="inventoryCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="inventory-products.html">Product List</a>
                    <a class="nav-link nav-sub-link" href="items-manage.html">Item Categories</a>
                    <a class="nav-link nav-sub-link" href="brands-manage.html">Brands</a>
                </nav>
            </div>
            <a class="nav-link" data-bs-toggle="collapse" href="#purchasesCollapse" role="button" aria-expanded="true">
                <i class="fa fa-shopping-cart fa-fw"></i> Purchases <i
                    class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="purchasesCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="purchases-create.html">New Purchase</a>
                    <a class="nav-link nav-sub-link" href="#">Purchase List</a>
                </nav>
            </div>
            <a class="nav-link" data-bs-toggle="collapse" href="#salesCollapse" role="button" aria-expanded="true">
                <i class="fa fa-file-invoice-dollar fa-fw"></i> Sales <i
                    class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="salesCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="sales-create.html">New Invoice</a>
                    <a class="nav-link nav-sub-link" href="sales-manage-invoices.html">Invoice List</a>
                    <a class="nav-link nav-sub-link" href="sales-return-create.html">Process Return</a>
                </nav>
            </div>
            <a class="nav-link" data-bs-toggle="collapse" href="#financeCollapse" role="button" aria-expanded="true">
                <i class="fa fa-wallet fa-fw"></i> Finance <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="financeCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="expenses-manage.html">Manage Expenses</a>
                </nav>
            </div>
            <a class="nav-link" data-bs-toggle="collapse" href="#reportsCollapse" role="button" aria-expanded="true">
                <i class="fa fa-chart-pie fa-fw"></i> Reports <i class="fa fa-chevron-down fa-xs float-end mt-1"></i>
            </a>
            <div class="collapse show" id="reportsCollapse">
                <nav class="nav flex-column">
                    <a class="nav-link nav-sub-link" href="reports-sales.html">Sales Report</a>
                    <a class="nav-link nav-sub-link" href="reports-stock-ledger.html">Stock Ledger</a>
                    <a class="nav-link nav-sub-link" href="reports-customer-dues.html">Customer Dues</a>
                </nav>
            </div>
            <a class="nav-link" href="settings.html"><i class="fa fa-cog fa-fw"></i> Settings</a>
        </nav>
    </div>
    <main class="main-content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Create New Sale / Invoice</h1>
                <a href="sales-manage-invoices.html" class="btn btn-sm btn-outline-secondary"><i
                        class="fa fa-list me-1"></i> View All Invoices</a>
            </div>
            <div class="card">
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6"><label for="customerName" class="form-label">Customer Info *</label><input
                                type="text" class="form-control" id="customerName"
                                placeholder="Search Customer Name or Contact #" list="customer-list"><datalist
                                id="customer-list">
                                <option value="Md. Mahfooz | 01613-505311">
                                <option value="Rana (Sukran Group) | 01405-591026">
                                <option value="Salma Akter | 01773-047204">
                            </datalist></div>
                        <div class="col-md-3"><label for="invoiceDate" class="form-label">Invoice Date *</label><input
                                type="date" class="form-control" id="invoiceDate" value="2025-03-03"></div>
                        <div class="col-md-3"><label for="invoiceNumber" class="form-label">Invoice #</label><input
                                type="text" class="form-control" id="invoiceNumber" value="6084" readonly></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="invoice-items-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40%;">Item / Model #</th>
                                    <th style="width: 15%;">Stock</th>
                                    <th style="width: 10%;">Qty</th>
                                    <th style="width: 15%;">Unit Price</th>
                                    <th style="width: 15%;" class="text-end">Total</th>
                                    <th style="width: 5%;" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsTbody">
                                <tr>
                                    <td><input type="text" class="form-control item-selector"
                                            placeholder="Select or type product" list="product-list"><datalist
                                            id="product-list">
                                            <option data-price="25800" data-stock="14" value="43E40Z|SMART TV|VISION">
                                            <option data-price="34140" data-stock="5"
                                                value="WFB-2E0-GDEL-SC|REFRIGERATOR|WALTON">
                                            <option data-price="1760" data-stock="56" value="COMFORT|CEILING FAN|BORAK">
                                        </datalist></td>
                                    <td><input type="text" class="form-control-plaintext text-center item-stock"
                                            value="14" readonly></td>
                                    <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                                    <td><input type="number" class="form-control item-price" value="25800"></td>
                                    <td class="text-end align-middle fw-bold item-total">৳ 25,800.00</td>
                                    <td class="text-center align-middle"><button
                                            class="btn btn-sm btn-danger delete-row-btn"><i
                                                class="fa fa-trash"></i></button></td>
                                </tr>
                                <tr>
                                    <td><input type="text" class="form-control item-selector"
                                            value="COMFORT|CEILING FAN|BORAK" list="product-list"></td>
                                    <td><input type="text" class="form-control-plaintext text-center item-stock"
                                            value="56" readonly></td>
                                    <td><input type="number" class="form-control item-qty" value="2" min="1"></td>
                                    <td><input type="number" class="form-control item-price" value="1760"></td>
                                    <td class="text-end align-middle fw-bold item-total">৳ 3,520.00</td>
                                    <td class="text-center align-middle"><button
                                            class="btn btn-sm btn-danger delete-row-btn"><i
                                                class="fa fa-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary btn-sm" id="addItemBtn"><i class="fa fa-plus me-1"></i> Add Item
                        Row</button>

                    <!-- EMI Schedule and Totals are now in the same row for side-by-side layout -->
                    <div class="row mt-4">
                        <!-- EMI SCHEDULE COLUMN -->
                        <div class="col-lg-7 d-none" id="emiScheduleContainer">
                            <h5 class="mb-3">EMI Payment Schedule</h5>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-bordered table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Payment Date</th>
                                            <th class="text-end">Payment</th>
                                            <th class="text-end">Principal</th>
                                            <th class="text-end">Late Fee</th>
                                            <th class="text-end">Remaining Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emiScheduleTbody">
                                        <!-- Schedule rows will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- TOTALS COLUMN -->
                        <div class="col-lg-5">
                            <div class="invoice-total-box">
                                <div class="d-flex justify-content-between mb-2"><span>Subtotal:</span><span
                                        id="subtotalSpan">৳ 29,320.00</span></div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Discount:</span><span><input type="text"
                                            class="form-control form-control-sm text-end" style="width: 100px;"
                                            id="discountInput" value="0" placeholder="% or fixed"></span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold h4 mb-3"><span>GRAND
                                        TOTAL:</span><span id="grandTotalSpan">৳ 29,320.00</span></div>
                                <!-- EMI Controls -->
                                <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox"
                                        role="switch" id="enableEmiCheck"><label class="form-check-label"
                                        for="enableEmiCheck">Setup EMI Plan</label></div>
                                <div id="emiDetails" class="d-none ps-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2"><label
                                            for="emiInstallments" class="form-label mb-0">No. of
                                            Installments:</label><input type="number"
                                            class="form-control form-control-sm text-end" id="emiInstallments"
                                            style="width: 120px;" value="12" min="1"></div>
                                    <div class="d-flex justify-content-between align-items-center mb-2"><label
                                            for="emiInterestRate" class="form-label mb-0">Late Fee Rate
                                            (%):</label><input type="number"
                                            class="form-control form-control-sm text-end" id="emiInterestRate"
                                            style="width: 120px;" value="10" min="0"></div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between fw-bold mb-2"><span>Monthly
                                            Payment:</span><span id="monthlyPaymentSpan">৳ 0.00</span></div>
                                    <div class="d-flex justify-content-between text-muted"><small>Total w/
                                            Late Fee:</small><small id="totalPayableSpan">৳ 0.00</small></div>
                                </div>
                                <hr>
                                <!-- End EMI Controls -->
                                <div class="d-flex justify-content-between align-items-center mb-2"><label
                                        for="downPayment" class="col-form-label">Down Payment:</label><input
                                        type="number" class="form-control form-control-sm text-end" id="downPayment"
                                        style="width: 120px;" value="15000"></div>
                                <div class="d-flex justify-content-between text-danger fw-bold h5"
                                    id="closingDueWrapper"><span>CLOSING DUE:</span><span id="closingDueSpan">৳
                                        14,320.00</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12 text-end"><button class="btn btn-secondary"><i class="fa fa-save me-1"></i>
                                Save as Draft</button><button class="btn btn-success" id="finalizeBtn"><i
                                    class="fa fa-check-circle me-1"></i> Finalize and Generate Invoice</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Element References
            const tbody = document.getElementById("invoiceItemsTbody");
            const addItemBtn = document.getElementById("addItemBtn");
            const enableEmiCheck = document.getElementById("enableEmiCheck");
            const emiDetails = document.getElementById("emiDetails");
            const emiInstallmentsInput = document.getElementById("emiInstallments");
            const emiInterestRateInput = document.getElementById("emiInterestRate");
            const monthlyPaymentSpan = document.getElementById("monthlyPaymentSpan");
            const totalPayableSpan = document.getElementById("totalPayableSpan");
            const closingDueWrapper = document.getElementById("closingDueWrapper");
            const emiScheduleContainer = document.getElementById("emiScheduleContainer");
            const emiScheduleTbody = document.getElementById("emiScheduleTbody");
            const allInputs = document.querySelectorAll('#discountInput, #downPayment, #enableEmiCheck, #emiInstallments, #emiInterestRate, #invoiceDate');

            // The main function to calculate everything
            function updateAllCalculations() {
                let subtotal = 0;
                tbody.querySelectorAll("tr").forEach(row => {
                    const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
                    const price = parseFloat(row.querySelector(".item-price").value) || 0;
                    const total = qty * price;
                    row.querySelector(".item-total").textContent = `৳ ${total.toFixed(2)}`;
                    subtotal += total;
                });
                document.getElementById("subtotalSpan").textContent = `৳ ${subtotal.toFixed(2)}`;

                const discountInput = document.getElementById("discountInput").value;
                let discountAmount = 0;
                if (discountInput.includes("%")) {
                    const percentage = parseFloat(discountInput.replace("%", "")) || 0;
                    discountAmount = (percentage / 100) * subtotal;
                } else {
                    discountAmount = parseFloat(discountInput) || 0;
                }

                const grandTotal = subtotal - discountAmount;
                document.getElementById("grandTotalSpan").textContent = `৳ ${grandTotal.toFixed(2)}`;

                const downPayment = parseFloat(document.getElementById("downPayment").value) || 0;
                const loanAmount = grandTotal - downPayment;

                // Handle EMI or regular due calculation
                if (enableEmiCheck.checked) {
                    emiDetails.classList.remove("d-none");
                    closingDueWrapper.classList.add("d-none");
                    emiScheduleContainer.classList.remove("d-none");

                    const installments = parseInt(emiInstallmentsInput.value) || 1;
                    const annualInterestRate = parseFloat(emiInterestRateInput.value) || 0;

                    generateAndShowEmiSchedule(loanAmount, installments, annualInterestRate);

                } else {
                    emiDetails.classList.add("d-none");
                    closingDueWrapper.classList.remove("d-none");
                    emiScheduleContainer.classList.add("d-none");
                    document.getElementById("closingDueSpan").textContent = `৳ ${loanAmount.toFixed(2)}`;
                    monthlyPaymentSpan.textContent = "৳ 0.00";
                    totalPayableSpan.textContent = "৳ 0.00";
                }
            }

            function generateAndShowEmiSchedule(principal, installments, annualRate) {
                if (principal <= 0 || installments <= 0) {
                    emiScheduleTbody.innerHTML = '<tr><td colspan="6" class="text-center">Enter a valid amount and number of installments.</td></tr>';
                    monthlyPaymentSpan.textContent = `৳ 0.00`;
                    totalPayableSpan.textContent = `৳ ${(principal < 0 ? 0 : principal) + (parseFloat(document.getElementById("downPayment").value) || 0).toFixed(2)}`;
                    return;
                }

                let monthlyPayment;
                const monthlyRate = annualRate / 100 / 12;

                if (monthlyRate > 0) {
                    const pow = Math.pow(1 + monthlyRate, installments);
                    monthlyPayment = principal * (monthlyRate * pow) / (pow - 1);
                } else {
                    monthlyPayment = principal / installments; // No interest
                }

                const totalPayableWithInterest = monthlyPayment * installments;
                const downPayment = parseFloat(document.getElementById("downPayment").value) || 0;
                monthlyPaymentSpan.textContent = `৳ ${monthlyPayment.toFixed(2)}`;
                totalPayableSpan.textContent = `৳ ${(totalPayableWithInterest + downPayment).toFixed(2)}`;

                // Generate Schedule Table
                let scheduleHtml = '';
                let remainingBalance = principal;
                const startDateValue = document.getElementById('invoiceDate').value;
                const startDate = new Date(startDateValue + 'T00:00:00'); // Avoid timezone issues

                for (let i = 1; i <= installments; i++) {
                    const interestForMonth = remainingBalance * monthlyRate;
                    const principalForMonth = monthlyPayment - interestForMonth;
                    remainingBalance -= principalForMonth;

                    // To prevent small negative balance at the end due to floating point math
                    if (i === installments) {
                        remainingBalance = 0;
                    }

                    // Calculate payment date
                    const paymentDate = new Date(startDate);
                    paymentDate.setMonth(startDate.getMonth() + i);

                    scheduleHtml += `
                        <tr>
                            <td>${i}</td>
                            <td>${paymentDate.toLocaleDateString()}</td>
                            <td class="text-end">৳ ${monthlyPayment.toFixed(2)}</td>
                            <td class="text-end">৳ ${principalForMonth.toFixed(2)}</td>
                            <td class="text-end">৳ ${interestForMonth.toFixed(2)}</td>
                            <td class="text-end fw-bold">৳ ${remainingBalance.toFixed(2)}</td>
                        </tr>
                    `;
                }
                emiScheduleTbody.innerHTML = scheduleHtml;
            }

            // Event Listeners
            addItemBtn.addEventListener("click", () => {
                const newRowHtml = `
                    <tr>
                        <td><input type="text" class="form-control item-selector" placeholder="Select or type product" list="product-list"></td>
                        <td><input type="text" class="form-control-plaintext text-center item-stock" value="-" readonly></td>
                        <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                        <td><input type="number" class="form-control item-price" value="0"></td>
                        <td class="text-end align-middle fw-bold item-total">৳ 0.00</td>
                        <td class="text-center align-middle"><button class="btn btn-sm btn-danger delete-row-btn"><i class="fa fa-trash"></i></button></td>
                    </tr>`;
                tbody.insertAdjacentHTML("beforeend", newRowHtml);
            });

            tbody.addEventListener("input", e => {
                const target = e.target;
                if (target.classList.contains("item-selector")) {
                    const selectedValue = target.value;
                    const options = document.getElementById("product-list").options;
                    for (let option of options) {
                        if (option.value === selectedValue) {
                            const row = target.closest("tr");
                            row.querySelector(".item-price").value = option.dataset.price || 0;
                            row.querySelector(".item-stock").value = option.dataset.stock || "-";
                            break;
                        }
                    }
                }
                if (target.matches(".item-qty, .item-price, .item-selector")) {
                    updateAllCalculations();
                }
            });

            tbody.addEventListener("click", e => {
                if (e.target.closest(".delete-row-btn")) {
                    e.target.closest("tr").remove();
                    updateAllCalculations();
                }
            });

            allInputs.forEach(input => {
                input.addEventListener('input', updateAllCalculations);
                if (input.type === 'checkbox') {
                    input.addEventListener('change', updateAllCalculations);
                }
            });

            document.getElementById("finalizeBtn").addEventListener("click", () => {
                alert('Invoice Finalized! \nIn a real app, this would save to the database and generate a PDF.');
            });

            // Initial calculation on page load
            updateAllCalculations();
        });
    </script>
</body>

</html>